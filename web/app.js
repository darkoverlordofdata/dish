// Generated by CoffeeScript 1.10.0
System.register("ffi", [], function(exports_1, context_1) {
    "use strict";
    var __moduleName = context_1 && context_1.id;
    var Ffi, HEAP, HEAP_SIZE, allocator, buffer, foreign, bufferMax;
    return {
        setters:[],
        execute: function() {
            /*
            ## Foreign function interface
             */
            HEAP_SIZE = 0x40000;
            Ffi = (function () {
                function Ffi() { }
                Ffi.EntityIsNotEnabledException = function () {
                    throw new Error('EntityIsNotEnabledException');
                };
                Ffi.EntityAlreadyHasComponentException = function (index) {
                    throw new Error("EntityAlreadyHasComponentException - " + index);
                };
                Ffi.now = function () {
                    return performance.now();
                };
                /*
                 * malloc
                 *
                 * @param nBytes number of bytes required
                 * @returns starting offset in the heap
                 */
                Ffi.malloc = function (nBytes) {
                    var offset;
                    if (typeof malloc !== "undefined" && malloc !== null) {
                        return allocator.alloc(nBytes);
                    }
                    else {
                        /*
                        * Fallback:
                        * this is a naive implementation of malloc.
                        * memory is only allocated, never freed.
                         */
                        offset = HEAP[0];
                        HEAP[0] = offset + nBytes;
                        return offset;
                    }
                };
                Ffi.free = function (addr) {
                    if (typeof malloc !== "undefined" && malloc !== null) {
                        return allocator.free(addr);
                    }
                };
                return Ffi;
            })();
            exports_1("default",Ffi);
            exports_1("buffer", buffer = new ArrayBuffer(HEAP_SIZE));
            exports_1("foreign", foreign = Ffi);
            exports_1("bufferMax", bufferMax = HEAP_SIZE);
            if (typeof malloc !== "undefined" && malloc !== null) {
                allocator = new malloc.Allocator(buffer);
            }
            else {
                HEAP = new Int32Array(buffer);
                HEAP[0] = 16;
            }
        }
    }
});
// Generated by CoffeeScript 1.10.0
System.register("stdlib", [], function(exports_2, context_2) {
    "use strict";
    var __moduleName = context_2 && context_2.id;
    var Stdlib;
    return {
        setters:[],
        execute: function() {
            /*
            ## Stdlib
             */
            Stdlib = (function () {
                function Stdlib() { }
                Stdlib.Math = Math;
                Stdlib.Int8Array = Int8Array;
                Stdlib.Int16Array = Int16Array;
                Stdlib.Int32Array = Int32Array;
                Stdlib.Uint8Array = Uint8Array;
                Stdlib.Uint16Array = Uint16Array;
                Stdlib.Uint32Array = Uint32Array;
                Stdlib.Float32Array = Float32Array;
                Stdlib.Float64Array = Float64Array;
                Stdlib.NaN = NaN;
                Stdlib.Infinity = Infinity;
                return Stdlib;
            })();
            exports_2("default",Stdlib);
        }
    }
});
System.register("Entity", ["ffi", "stdlib"], function(exports_3, context_3) {
    "use strict";
    var __moduleName = context_3 && context_3.id;
    var ffi_1, ffi_2, stdlib_1;
    var Entity;
    return {
        setters:[
            function (ffi_1_1) {
                ffi_1 = ffi_1_1;
                ffi_2 = ffi_1_1;
            },
            function (stdlib_1_1) {
                stdlib_1 = stdlib_1_1;
            }],
        execute: function() {
            exports_3("Entity", Entity = (function (stdlib, foreign, heap) {
                "use asm";
                var HEAPI32 = new stdlib.Int32Array(heap);
                var HEAPF64 = new stdlib.Float64Array(heap);
                var malloc = foreign.malloc;
                var free = foreign.free;
                function Entity(self, totalComponents) {
                    self = self | 0;
                    totalComponents = totalComponents | 0;
                    var __01__ = 0, __02__ = 0;
                    __01__ = self + 2;
                    __02__ = __01__ << 2;
                    HEAPI32[__02__ >> 2] = totalComponents;
                }
                function getId(self) {
                    self = self | 0;
                    var __00__ = 0, __01__ = 0, __02__ = 0;
                    __01__ = self + 0;
                    __02__ = __01__ << 2;
                    __00__ = HEAPI32[__02__ >> 2];
                    return __00__ | 0;
                }
                function setId(self, id) {
                    self = self | 0;
                    id = id | 0;
                    var __01__ = 0, __02__ = 0;
                    __01__ = self + 0;
                    __02__ = __01__ << 2;
                    HEAPI32[__02__ >> 2] = id;
                }
                function getEnabled(self) {
                    self = self | 0;
                    var __00__ = 0, __01__ = 0, __02__ = 0;
                    __01__ = self + 1;
                    __02__ = __01__ << 2;
                    __00__ = HEAPI32[__02__ >> 2];
                    return __00__ | 0;
                }
                function setEnabled(self, enabled) {
                    self = self | 0;
                    enabled = enabled | 0;
                    var __01__ = 0, __02__ = 0;
                    __01__ = self + 1;
                    __02__ = __01__ << 2;
                    HEAPI32[__02__ >> 2] = enabled;
                }
                function getComponent(self, index) {
                    self = self | 0;
                    index = index | 0;
                    var __00__ = 0, __01__ = 0, __02__ = 0, __03__ = 0;
                    __01__ = index + 3;
                    __02__ = self + __01__;
                    __03__ = __02__ << 2;
                    __00__ = HEAPI32[__03__ >> 2];
                    return __00__ | 0;
                }
                function setComponent(self, index, value) {
                    self = self | 0;
                    index = index | 0;
                    value = value | 0;
                    var __01__ = 0, __02__ = 0, __03__ = 0;
                    __01__ = index + 3;
                    __02__ = self + __01__;
                    __03__ = __02__ << 2;
                    HEAPI32[__03__ >> 2] = value;
                }
                function hasComponent(self, index) {
                    self = self | 0;
                    index = index | 0;
                    var __00__ = 0, __01__ = 0, __02__ = 0, __03__ = 0;
                    var comp = 0;
                    __01__ = index + 3 | 0;
                    __02__ = self + __01__ | 0;
                    __03__ = __02__ << 2;
                    comp = HEAPI32[__03__ >> 2] | 0;
                    if (comp > 0) {
                        __00__ = 1;
                        return __00__ | 0;
                    }
                    else {
                        __00__ = 0;
                        return __00__ | 0;
                    }
                }
                return {
                    Entity: Entity,
                    getId: getId,
                    setId: setId,
                    getEnabled: getEnabled,
                    setEnabled: setEnabled,
                    getComponent: getComponent,
                    setComponent: setComponent,
                    hasComponent: hasComponent,
                };
            }(stdlib_1.default, ffi_1.default, ffi_2.buffer)));
            for (var k in Entity) {
                ffi_1.default['Entity_' + k] = Entity[k];
            }
        }
    }
});
System.register("Position", ["ffi", "stdlib"], function(exports_4, context_4) {
    "use strict";
    var __moduleName = context_4 && context_4.id;
    var ffi_3, ffi_4, stdlib_2;
    var Position;
    return {
        setters:[
            function (ffi_3_1) {
                ffi_3 = ffi_3_1;
                ffi_4 = ffi_3_1;
            },
            function (stdlib_2_1) {
                stdlib_2 = stdlib_2_1;
            }],
        execute: function() {
            exports_4("Position", Position = (function (stdlib, foreign, heap) {
                "use asm";
                var HEAPF64 = new stdlib.Float64Array(heap);
                function Position(self, x, y) {
                    self = self | 0;
                    x = +x;
                    y = +y;
                    var __01__ = 0, __02__ = 0, __03__ = 0, __04__ = 0;
                    __01__ = self + 0;
                    __02__ = __01__ << 2;
                    HEAPF64[__02__ >> 2] = x;
                    __03__ = self + 2;
                    __04__ = __03__ << 2;
                    HEAPF64[__04__ >> 2] = y;
                }
                function getX(self) {
                    self = self | 0;
                    var __00__ = 0.0, __01__ = 0, __02__ = 0;
                    var x = 0.0;
                    __01__ = +(self + 0);
                    __02__ = +(__01__ << 2);
                    x = +HEAPF64[__02__ >> 2];
                    __00__ = x;
                    return +__00__;
                }
                function setX(self, x) {
                    self = self | 0;
                    x = +x;
                    var __01__ = 0, __02__ = 0;
                    __01__ = self + 0;
                    __02__ = __01__ << 2;
                    HEAPF64[__02__ >> 2] = x;
                }
                function getY(self) {
                    self = self | 0;
                    var __00__ = 0.0, __01__ = 0, __02__ = 0;
                    var y = 0.0;
                    __01__ = +(self + 2);
                    __02__ = +(__01__ << 2);
                    y = +HEAPF64[__02__ >> 2];
                    __00__ = y;
                    return +__00__;
                }
                function setY(self, y) {
                    self = self | 0;
                    y = +y;
                    var __01__ = 0, __02__ = 0;
                    __01__ = self + 2;
                    __02__ = __01__ << 2;
                    HEAPF64[__02__ >> 2] = y;
                }
                return {
                    Position: Position,
                    getX: getX,
                    setX: setX,
                    getY: getY,
                    setY: setY,
                };
            }(stdlib_2.default, ffi_3.default, ffi_4.buffer)));
            for (var k in Position) {
                ffi_3.default['Position_' + k] = Position[k];
            }
        }
    }
});
System.register("pool", ["ffi", "stdlib"], function(exports_5, context_5) {
    "use strict";
    var __moduleName = context_5 && context_5.id;
    var ffi_5, ffi_6, stdlib_3;
    var pool;
    return {
        setters:[
            function (ffi_5_1) {
                ffi_5 = ffi_5_1;
                ffi_6 = ffi_5_1;
            },
            function (stdlib_3_1) {
                stdlib_3 = stdlib_3_1;
            }],
        execute: function() {
            exports_5("pool", pool = (function (stdlib, foreign, heap) {
                "use asm";
                var HEAPI32 = new stdlib.Int32Array(heap);
                var HEAPF64 = new stdlib.Float64Array(heap);
                var malloc = foreign.malloc;
                var free = foreign.free;
                var Entity_Entity = foreign.Entity_Entity;
                var Entity_getId = foreign.Entity_getId;
                var Entity_setId = foreign.Entity_setId;
                var Entity_getEnabled = foreign.Entity_getEnabled;
                var Entity_setEnabled = foreign.Entity_setEnabled;
                var Entity_getComponent = foreign.Entity_getComponent;
                var Entity_setComponent = foreign.Entity_setComponent;
                var Entity_hasComponent = foreign.Entity_hasComponent;
                var Position_Position = foreign.Position_Position;
                var Position_getX = foreign.Position_getX;
                var Position_setX = foreign.Position_setX;
                var Position_getY = foreign.Position_getY;
                var Position_setY = foreign.Position_setY;
                var EntityIsNotEnabledException = foreign.EntityIsNotEnabledException;
                var EntityAlreadyHasComponentException = foreign.EntityAlreadyHasComponentException;
                var POOL_SIZE = 4096;
                var init = 1;
                var pool = 0;
                var totalComponents = 0;
                var count = 0;
                var index = 0;
                var uniqueId = 0;
                function initialize(count) {
                    count = count | 0;
                    if (init) {
                        totalComponents = count;
                        uniqueId = 0;
                        pool = (malloc(POOL_SIZE << 2) | 0) >> 2;
                        init = 0;
                    }
                }
                function createPos(x, y) {
                    x = +x;
                    y = +y;
                    var __00__ = 0;
                    __00__ = (malloc(16 << 2) | 0) >> 2;
                    Position_Position(__00__ | 0, x, y);
                    return __00__ | 0;
                }
                function getTotalComponents() {
                    var __00__ = 0;
                    __00__ = totalComponents;
                    return __00__ | 0;
                }
                function getCount() {
                    var __00__ = 0;
                    __00__ = count;
                    return __00__ | 0;
                }
                function createEntity() {
                    var __00__ = 0;
                    var ent = 0;
                    var i = 0;
                    uniqueId = uniqueId + 1 | 0;
                    ent = (malloc(92 << 2) | 0) >> 2;
                    Entity_Entity(ent | 0, totalComponents);
                    Entity_setId(ent | 0, uniqueId | 0);
                    Entity_setEnabled(ent | 0, 1 | 0);
                    for (i = 0; (i | 0) < (totalComponents | 0); i = i + 1 | 0) {
                        Entity_setComponent(ent | 0, i | 0, 0 | 0);
                    }
                    __00__ = ent;
                    return __00__ | 0;
                }
                function destroyEntity(entity) {
                    entity = entity | 0;
                    free(entity | 0);
                }
                function destroyAllEntities() {
                }
                function hasEntity(entity) {
                    entity = entity | 0;
                    var __00__ = 0;
                }
                function getEntities(matching) {
                    matching = matching | 0;
                    var __00__ = 0;
                }
                function getGroup(matching) {
                    matching = matching | 0;
                    var __00__ = 0;
                }
                function updateGroupsComponentAddedOrRemoved(entity, index, component) {
                    entity = entity | 0;
                    index = index | 0;
                    component = component | 0;
                }
                function updateGroupsComponentReplaced(entity, index, prevcomponent, newcomponent) {
                    entity = entity | 0;
                    index = index | 0;
                    prevcomponent = prevcomponent | 0;
                    newcomponent = newcomponent | 0;
                }
                function onEntityReleased(entity) {
                    entity = entity | 0;
                }
                function addComponent(entity, index, component) {
                    entity = entity | 0;
                    index = index | 0;
                    component = component | 0;
                    var enabled = 0;
                    var comp = 0;
                    enabled = Entity_getEnabled(entity | 0) | 0;
                    if (!enabled) {
                        EntityIsNotEnabledException();
                    }
                    comp = Entity_hasComponent(entity | 0, index) | 0;
                    if (comp) {
                        EntityAlreadyHasComponentException(index | 0);
                    }
                    Entity_setComponent(entity | 0, index | 0, component | 0);
                }
                function removeComponent(entity, index) {
                    entity = entity | 0;
                    index = index | 0;
                }
                function replaceComponent(entity, index, component) {
                    entity = entity | 0;
                    index = index | 0;
                    component = component | 0;
                }
                function getComponent(entity, index) {
                    entity = entity | 0;
                    index = index | 0;
                    var __00__ = 0;
                }
                function hasComponent(entity, index) {
                    entity = entity | 0;
                    index = index | 0;
                    var __00__ = 0;
                }
                return {
                    initialize: initialize,
                    createPos: createPos,
                    getTotalComponents: getTotalComponents,
                    getCount: getCount,
                    createEntity: createEntity,
                    destroyEntity: destroyEntity,
                    destroyAllEntities: destroyAllEntities,
                    hasEntity: hasEntity,
                    getEntities: getEntities,
                    getGroup: getGroup,
                    updateGroupsComponentAddedOrRemoved: updateGroupsComponentAddedOrRemoved,
                    updateGroupsComponentReplaced: updateGroupsComponentReplaced,
                    onEntityReleased: onEntityReleased,
                    addComponent: addComponent,
                    removeComponent: removeComponent,
                    replaceComponent: replaceComponent,
                    getComponent: getComponent,
                    hasComponent: hasComponent,
                };
            }(stdlib_3.default, ffi_5.default, ffi_6.buffer)));
            for (var k in pool) {
                ffi_5.default['pool_' + k] = pool[k];
            }
        }
    }
});
// Generated by CoffeeScript 1.10.0
/*
 * Run tests
 */
Promise.all(['Entity', 'Position', 'pool'].map(function (x) {
    return System["import"](x);
})).then(function (arg) {
    var Entity, Position, pool, ref, ref1, ref2;
    (ref = arg[0], Entity = ref.Entity), (ref1 = arg[1], Position = ref1.Position), (ref2 = arg[2], pool = ref2.pool);
    return describe('Entitas / asm.js', function () {
        console.log('hello');
        it('Create entity', function () {
            var MAX, e1, e2, i, j, ref3;
            MAX = 4;
            console.log(MAX);
            pool.initialize(10);
            e1 = pool.createEntity();
            expect(Entity.getId(e1)).to.equal(1);
            Entity.setEnabled(e1, 0);
            expect(Entity.getEnabled(e1)).to.equal(0);
            for (i = j = 0, ref3 = MAX; 0 <= ref3 ? j <= ref3 : j >= ref3; i = 0 <= ref3 ? ++j : --j) {
                e2 = pool.createEntity();
            }
            return expect(Entity.getId(e2)).to.equal(MAX + 2);
        });
        it('Create Position', function () {
            var fm, pos;
            pool.initialize(10);
            pos = pool.createPos(95.0, 96.0);
            fm = pool.createPos(99.9, 107.7);
            expect(Position.getX(pos)).to.equal(95);
            return expect(Position.getY(pos)).to.equal(96);
        });
        it('Create Entity with Position', function () {
            var e3, pos, poz;
            pool.initialize(10);
            e3 = pool.createEntity();
            pos = pool.createPos(95.0, 96.0);
            pool.addComponent(e3, 1, pos);
            poz = Entity.getComponent(e3, 1);
            expect(Position.getX(poz)).to.equal(95);
            return expect(Position.getY(poz)).to.equal(96);
        });
        return it('Raise EntityAlreadyHasComponentException', function () {
            var e4, error, ex, fm, pos, poz;
            pool.initialize(10);
            e4 = pool.createEntity();
            pos = pool.createPos(95.0, 96.0);
            pool.addComponent(e4, 2, pos);
            poz = Entity.getComponent(e4, 2);
            fm = pool.createPos(99.9, 107.7);
            try {
                return pool.addComponent(e4, 2, fm);
            }
            catch (error) {
                ex = error;
                return expect(ex.message).to.equal("EntityAlreadyHasComponentException - 2");
            }
        });
    });
}, function (err) {
    return console.log(err);
});
